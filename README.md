# ATECC608 Tools 

Tools to work with Atmel Crypto-Authentication (ATCA) library and devices.

## Tools list

Primitives (simple commands):

- `aes_decrypt`: AES128 decrypt a block using a key in a given slot.
- `aes_encrypt`: AES128 encrypt a block using a key in a given slot.
- `check_mac`: Issue a Check MAC command that can also be used to authorize a key.
- `derivekey`: Create a new key from a parent, itself and tempkey.
- `gendig`: Issue a gendig-data command with the specified slot.
- `load_tempkey`: Load TempKey with a given value.
- `mac`: Generate a MAC of the TempKey + Slot Key
- `nonce_rand`: Generate a random nonce with a challenge.
- `random`: Retrieve a random number (or `FF FF 00 00 ...` if unlocked)
- `read_slot`: Read the first 32 bits from a data slot (cleartext)
- `serial`: Get the chip's serial number.
- `sha`: Calculate SHA256 of the message.
- `state`: Display device internal state.
- `write_8`: Write data in slot 08.
- `write_enc`: Write data using a writing key.
- `write_slot`: Write 32 bytes of data to any slot.


Use cases (multiple commands):

- `auth_aes_dec`: Decrypt a block of data using a secret symmetric key that requires Authorization
- `auth_aes_enc`: Encrypt a block of data using a secret symmetric key that requires Authorization
- `authorize.sh`: Performs a Check MAC with an authorization key in order to tell the device we know that key.
- `chip_info`: Dump some information about the device.
- `eyc_original.sh`: Verify an Original EyC component and retrieve verified data from a slot.
- `read_encrypted.sh`: Read the contents of any slot encrypted with a Read key.
- `rotate_key.sh`: Rotate a key from a parent key and a randon nonce.
- `setup_608`: Configure ATECC608 with the configuration below.


Tools (auxiliary):

- `xor`: Get two hexadecimal strings and return the xor.


## Setup 608 configuration

### Summary

Slot | Key Type    | Read | Write | Usage
----:|-------------|------|-------|-------------
  00 | ECC Private | No   | Yes   | Device key. No usage restrictions.
  01 | AES         | 7    | 7     | Symmetric key.
  02 | AES         | 7    | 7     | Symmetric key with limited uses.
  03 | AES         | Yes  | Yes   | Symmetric key for debug.
  04 | SHA         | 7    | 7     | Secret. Require random.
  05 | SHA         | 7    | 7     | Secret with limited uses. Require random.
  06 | SHA         | Yes  | Yes   | Secret for debug.
  07 | SHA         | 7    | 7     | Secret for encrypted I/O.
  08 | Data        | Yes  | Yes   | Info: Date, Model, Trademark, uuid.
  09 | ECC Public  | Yes  | Yes   | Public key for ECC on key 1.
  10 | SHA         | 0    | 7     | Secret for Checkmac/Copy source.
  11 | SHA         | 0    | 7     | Secret for Checkmac/Copy destination.
  12 | AES         | No   | 13    | Symmetric key. Secret. Requires authorization by key 13.
  13 | SHA         | No   | 13    | Secret to protect key 12. Require random.
  14 | ECC Public  | Yes  | Yes   | External key storage.
  15 | Data        | Yes  | 7     | Secure info (you need to know key 7 to write it).

All slots are lockable.

Keys 7 and 13 and initialized to a random value generated by the device and only displayed once.
You can change them knowing their current value.


### EEPROM

OTP EEPROM value will be like this:
```
1.0|2024/03/21|Electronica y Ciencia|www.electronicayciencia.com
```

### Counters

Counters 0 and 1 are initialized to 1000.

### Detailed keys purpose

#### Slot 0

Private key to sign with the device.

This key never leaves the chip so whomever uses this key has the chip.

It doesn't require authentication, so everybody can use it as long as they have
the chip.

But it requires random nonce before use, so a replay attack is not possible.


```c
config_data->SlotConfig[slot] = 
    ATCA_SLOT_CONFIG_EXT_SIG_MASK      // External signatures of arbitrary messages are enabled.
  | ATCA_SLOT_CONFIG_INT_SIG_MASK      // Internal signatures of messages generated by GenDig or GenKey are enabled.
  | ATCA_SLOT_CONFIG_ECDH_MASK         // ECDH operation is permitted for this key.
  | ATCA_SLOT_CONFIG_IS_SECRET_MASK    // The contents of this slot are secret
  | ATCA_SLOT_CONFIG_GEN_KEY_MASK      // GenKey may be used to write random keys into this slot.
  ;

config_data->KeyConfig[slot] = 
    ATCA_KEY_CONFIG_PRIVATE_MASK       // The key slot contains an ECC private key
  | ATCA_KEY_CONFIG_PUB_INFO_MASK      // The public version of this key can always be generated.
  | ATCA_KEY_CONFIG_KEY_TYPE(ATCA_P256_KEY_TYPE)        // 4: P256 NIST ECC key / 6: AES-128 key / 7: Not an ECC key
  | ATCA_KEY_CONFIG_LOCKABLE_MASK      // Slot can be individually locked using the Lock command.
  | ATCA_KEY_CONFIG_REQ_RANDOM_MASK    // A random nonce is required.
  ;
```

#### Slot 1

Symmetric AES key for encription/decryption of external input data.

It is readable and writable if you know key 7.

It doesn't require authentication, so everybody can use it as long as they have
the chip.

AES is used only with external input, so a random nonce is not required.

Example:

```console
$ ./aes_encrypt 1 00000000000000000000000000000000
ec85f660317fc53302b54d1fa7dab892
```



```c
config_data->SlotConfig[slot] = 
    ATCA_SLOT_CONFIG_READKEY(7)        // Use this KeyID to encrypt data read from this slot. 0 only for CheckMac/Copy
  | ATCA_SLOT_CONFIG_ENC_READ_MASK     // Reads from this slot will be encrypted. IsSecret must also be set
  | ATCA_SLOT_CONFIG_IS_SECRET_MASK    // The contents of this slot are secret
  | ATCA_SLOT_CONFIG_WRITE_KEY(7)      // Use this key to validate and encrypt data written to this slot
  | ATCA_SLOT_CONFIG_WRITE_CONFIG(0b0111)   // Encrypted write, derive key from parent
  ;

config_data->KeyConfig[slot] = 
    ATCA_KEY_CONFIG_KEY_TYPE(ATCA_AES_KEY_TYPE) // Key type
  | ATCA_KEY_CONFIG_LOCKABLE_MASK      // Slot can be individually locked using the Lock command.
  ;
```

#### Slot 2

Like key 1 but with limited uses.

Counter 0 is increased every time this key is used.


```c
config_data->SlotConfig[slot] = 
    ATCA_SLOT_CONFIG_READKEY(7)        // Use this KeyID to encrypt data read from this slot. 0 only for CheckMac/Copy
  | ATCA_SLOT_CONFIG_ENC_READ_MASK     // Reads from this slot will be encrypted. IsSecret must also be set
  | ATCA_SLOT_CONFIG_LIMITED_USE_MASK  // The key stored in the slot is Limited Use.
  | ATCA_SLOT_CONFIG_IS_SECRET_MASK    // The contents of this slot are secret
  | ATCA_SLOT_CONFIG_WRITE_KEY(7)      // Use this key to validate and encrypt data written to this slot
  | ATCA_SLOT_CONFIG_WRITE_CONFIG(0b0111)   // Encrypted write, derive key from parent
  ;

config_data->KeyConfig[slot] = 
    ATCA_KEY_CONFIG_KEY_TYPE(ATCA_AES_KEY_TYPE)        // 4: P256 NIST ECC key / 6: AES-128 key / 7: Not an ECC key
  | ATCA_KEY_CONFIG_LOCKABLE_MASK      // Slot can be individually locked using the Lock command.
  ;
```


#### Slot 3

Like key 1, but publicly readable and writable.

You can use it for debug o for a ephemeral session key.

To read the value:

```console
$ ./read_slot 3
0000000000000000000000000000000000000000000000000000000000000000
```

To write:

```console
$ ./write_slot 3 0000000000000000000000000000000000000000000000000000000000000000
Ok
```

To encrypt/decrypt:

```console
$ ./aes_encrypt 3 00000000000000000000000000000000
66e94bd4ef8a2c3b884cfa59ca342b2e

$ ./aes_decrypt 3 66e94bd4ef8a2c3b884cfa59ca342b2e
00000000000000000000000000000000
```



```c
config_data->SlotConfig[slot] = 
    ATCA_SLOT_CONFIG_READKEY(7)       // Use this KeyID to encrypt data read from this slot. 0 only for CheckMac/Copy
  | ATCA_SLOT_CONFIG_WRITE_KEY(7)     // Use this key to validate and encrypt data written to this slot
  | ATCA_SLOT_CONFIG_WRITE_CONFIG(0)   // Always read/write
  ;

config_data->KeyConfig[slot] = 
    ATCA_KEY_CONFIG_KEY_TYPE(ATCA_AES_KEY_TYPE)        // 4: P256 NIST ECC key / 6: AES-128 key / 7: Not an ECC key
  ;
```

#### Slot 4



#### Slot 5
#### Slot 6
#### Slot 7
#### Slot 8
#### Slot 9
#### Slot 10
#### Slot 11
#### Slot 12
#### Slot 13
#### Slot 14
#### Slot 15


## Customize

Edit `device_cfg.c` for your device. Then edit `atca_config.h` to enable proper
things.

## Build

### Compile the library

In Raspberry Pi with native I2C HAL:

```console
cd cryptoauthlib
cmake . -DATCA_HAL_I2C:BOOL=ON
make
```

The file `cryptoauthlib/lib/libcryptoauth.so` is created.

### Applications

`make`

That's it.

## Run

Export the library. Also setup `~/.bashrc`:

```bash
export LD_LIBRARY_PATH=$HOME/atca/cryptoauthlib/lib
```

